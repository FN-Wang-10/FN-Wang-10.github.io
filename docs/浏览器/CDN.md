关键词：

- 内容分发
- 缓存代理
- 负载均衡
- 调度
- 边缘节点（边缘服务器）

浏览器输入 URL————DNS 解析（本地 DNS 系统会将域名解析权交给 CDN 的专用 DNS 服务器，CNAME）————将全局负载均衡设备 IP 返给浏览器，向全局负载均衡服务器发请求————返回所属区域的负载均衡服务器，向这台设备发请求————返回一个最佳的 CDN 节点服务器（缓存服务器），将数据返回给浏览器，如果没有数据，则向上一级的缓存服务器发请求，直到追溯到源站服务器

## 流程

1. 当用户输入网址回车后，经过本地 DNS 系统解析，DNS 会将最终的域名解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。
2. CDN 的 DNS 服务器将 CDN 的全局负载均衡 设备 ip 地址返回给浏览器
3. 用户向 CDN 的全局负载均衡服务器 发起内容 url 请求
4. CDN 全局负载均衡服务器根据 用户请求的 IP 地址，url 等信息，选择一台用户所属区域的负载均衡设备，告诉用户向这台设备发起请求。
5. CDN 区域负载均衡服务器会为用户 选择一台合适的缓存服务器提供服务，选择的依据主要是：离用户距离要近，缓存服务器上是否用户所需内容，以及各个缓存当前的一个负载均衡情况。选择出一个最优的 缓存服务器 ip 地址。
6. 全局负载均衡服务器将 缓存服务器的 ip 地址给到用户。
7. 用户向缓存服务器发起请求。缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果缓存服务器上没有用户想要的内容，那么这台服务器就会向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器，并将内容拉取到本地。

当用户在浏览器中输入网址并按回车后，本地 DNS 系统开始解析该网址。  
本地 DNS 系统会将该网址的域名解析权交给 CDN 的专用 DNS 服务器。  
CDN 的 DNS 服务器会根据 CDN 的全局负载均衡策略，返回一个距离用户最近的 CDN 设备 IP 地址给浏览器。  
用户向 CDN 的全局负载均衡服务器发起内容 URL 请求。  
CDN 全局负载均衡服务器会根据用户请求的 IP 地址、URL 等信息，选择一台用户所属区域的负载均衡设备，并告诉用户向这台设备发起请求。  
用户向 CDN 区域负载均衡服务器发起请求。  
CDN 区域负载均衡服务器会根据一定的策略，选择一个最佳的 CDN 节点服务器来响应用户的请求。  
CDN 节点服务器会向源站请求资源。  
源站响应请求并返回资源。  
CDN 节点服务器将获取到的资源缓存起来，并返回给用户。

## 一.是什么

CDN：(全称 Content Delivery Network)，即内容分发网络  
构建在现有网络基础之上的智能虚拟网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN 的关键技术主要有内容存储和分发技术

简单来讲，CDN 就是根据用户位置分配最近的资源  
于是，用户在上网的时候不用直接访问源站，而是访问离他“最近的”一个 CDN 节点，术语叫边缘节点，其实就是缓存了源站内容的代理服务器

## 二、原理分析

在没有应用 CDN 时，我们使用域名访问某一个站点时的路径为  
用户提交域名————浏览器对域名进行解释————DNS 解析得到目的主机的 IP 地址————根据 IP 地址访问发出请求————得到请求数据并回复

应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME(Canonical Name ) 别名记录，指向 CDN 的全局负载均衡  
CNAME 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键

### 1.负载均衡系统

由于没有返回 IP 地址，于是本地 DNS 会向负载均衡系统再发送请求 ，则进入到 CDN 的全局负载均衡系统进行智能调度：  
看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点  
看用户所在的运营商网络，找相同网络的边缘节点  
检查边缘节点的负载情况，找负载较轻的节点  
其他，比如节点的“健康状况”、服务能力、带宽、响应时间等  
结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问 CDN 的缓存代理

### 2.缓存代理

缓存系统是 CDN 的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源  
其中有两个衡量 CDN 服务质量的指标：  
命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比  
回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比
缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户  
回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源  
现在的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上

## 三、总结

CDN 目的是为了改善互联网的服务质量，通俗一点说其实就是提高访问速度  
CDN 构建了全国、全球级别的专网，让用户就近访问专网里的边缘节点，降低了传输延迟，实现了网站加速  
通过 CDN 的负载均衡系统，智能调度边缘节点提供服务，相当于 CDN 服务的大脑，而缓存系统相当于 CDN 的心脏，缓存命中直接返回给用户，否则回源

CDN 缓存
浏览器发送请求————服务器处理请求，返回响应，并将数据缓存在离你最近的 CDN 节点服务器上，下次请求数据，就不会进行回源操作
