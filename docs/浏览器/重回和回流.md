重绘：元素的外观样式发生改变，不影响布局，color,background-color  
回流(重排):元素的尺寸，布局，显隐发生变化，position，width，height，

回流（重排）一定会引起重绘，重绘不一定会引起回流（重排）

## 定义

**回流**：布局引擎会根据各种样式计算每个盒子在页面上的大小与位置  
**重绘**：当计算好盒模型的位置、大小及其他属性后，浏览器根据每个盒子特性进行绘制

## 浏览器解析渲染机制

1. 解析 HTML，生成 DOM 树，解析 CSS，生成 CSSOM 树
2. 将 DOM 树和 CSSOM 树结合，生成渲染树(Render Tree)
3. Layout(回流):根据生成的渲染树，进行回流(Layout)，得到节点的几何信息（位置，大小）
4. Painting(重绘):根据渲染树以及回流得到的几何信息，得到节点的绝对像素
5. Display:将像素发送给 GPU，展示在页面上

在页面初始渲染阶段，回流不可避免的触发，可以理解成页面一开始是空白的元素，后面添加了新的元素使页面布局发生改变

**回流：**当我们对 DOM 的修改引发了 DOM 几何尺寸的变化（比如修改元素的宽、高或隐藏元素等）时，浏览器需要重新计算元素的几何属性，然后再将计算的结果绘制出来  
**重绘：**当我们对 DOM 的修改导致了样式的变化（color 或 background-color），却并未影响其几何属性时，浏览器不需重新计算元素的几何属性、直接为该元素绘制新的样式，这里就仅仅触发了重绘

## 回流触发时机

回流这一阶段主要是计算节点的位置和几何信息，那么当页面布局和几何信息发生变化的时候，就需要回流，如下面情况：

1. 添加或删除可见的 DOM 元素
2. 元素的位置发生变化
3. 元素的尺寸发生变化（包括外边距、内边框、边框大小、高度和宽度等）
4. 内容发生变化，比如文本变化或图片被另一个不同尺寸的图片所替代
5. 页面一开始渲染的时候（这避免不了）
6. 浏览器的窗口尺寸变化（因为回流是根据视口的大小来计算元素的位置和大小的）
7. 还有一些容易被忽略的操作：获取一些特定属性的值
   offsetTop、offsetLeft、 offsetWidth、offsetHeight、scrollTop、scrollLeft、scrollWidth、scrollHeight、clientTop、clientLeft、 clientWidth、clientHeight
   这些属性有一个共性，就是需要通过即时计算得到。因此浏览器为了获取这些值，也会进行回流
   除此还包括 getComputedStyle 方法，原理是一样的

## 重绘触发时机

触发回流一定会触发重绘  
可以把页面理解为一个黑板，黑板上有一朵画好的小花。现在我们要把这朵从左边移到了右边，那我们要先确定好右边的具体位置，画好形状（回流），再画上它原有的颜色（重绘）
除此之外还有一些其他引起重绘行为：

1.  颜色的修改
2.  文本方向的修改
3.  阴影的修改

## 浏览器优化机制

由于每次重排都会造成额外的计算消耗，因此大多数浏览器都会通过队列化修改并批量执行来优化重排过程。浏览器会将修改操作放入到队列里，直到过了一段时间或者操作达到了一个阈值，才清空队列  
当你获取布局信息的操作的时候，会强制队列刷新，包括前面讲到的 offsetTop 等方法都会返回最新的数据  
因此浏览器不得不清空队列，触发回流重绘来返回正确的值

下面给出避免回流的经验：
如果想设定元素的样式，通过改变元素的 class 类名 (尽可能在 DOM 树的最里层)
避免设置多项内联样式  
应用元素的动画，使用 position 属性的 fixed 值或 absolute 值(如前文示例所提)  
避免使用 table 布局，table 中每个元素的大小以及内容的改动，都会导致整个 table 的重新计算  
对于那些复杂的动画，对其设置 position: fixed/absolute，尽可能地使元素脱离文档流，从而减少对其他元素的影响  
使用 css3 硬件加速，可以让 transform、opacity、filters 这些动画不会引起回流重绘  
避免使用 CSS 的 JavaScript 表达式

## 减少重绘和回流的方式？？？？

**CSS**  
使用 transform 替代 top  
 使用 visibility 替换 display:none  
 避免使用 table 布局  
 尽可能在 DOM 树的最末端改变 class  
 避免设置多层内联样式  
 将动画效果应用到 position 属性为 absoulte 或 fixed 的元素上  
 避免使用 css 表达式  
 将频繁重绘或者回流的节点设置为图层  
 css 硬件加速

**JavaScript**  
避免频繁操作样式  
 避免频繁操作 DOM  
 避免 频繁读取 会引发重绘/回流的属性  
 对具有复杂动画的元素 使用绝对定位
